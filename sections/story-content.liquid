{%- for block in section.blocks -%}

  {%- liquid
    if forloop.first
      assign heading_element = 'h1'
    else 
      assign heading_element = 'h2'
    endif
  -%}

  <div id="shopify-section-{{ block.id }}" class="shopify-section index-section mount-content-row" data-type="{{ block.type }}" {{ block.shopify_attributes }}>

    <div class="site-box-container container--fullscreen box--can-stick">

      {%- case block.type -%}

        {%- when 'text' -%}
        
          <div class="site-box box--big lap--box--small-fl box__heading box--typo-big box--center-align box--column-flow" data-order="0">

            <span class="site-box-background" aria-hidden="true">

              {% unless block.settings.image == blank %}  
                <img
                  src="{{ block.settings.image | img_url: '960x' }}" alt="{{ block.settings.image.alt | escape }}"
                  srcset="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="
                  data-srcset="{{ block.settings.image | img_url: '600x' }} 480w, {{ block.settings.image | img_url: '860x' }} 720w, {{ block.settings.image | img_url: '1100x' }} 960w, {{ block.settings.image | img_url: '1440x' }} 1600w, {{ block.settings.image | img_url: '2100x' }} 1920w"
                  data-sizes="auto"
                  class="lazyload" 
                />
                {%- if settings.show_preloader -%}
                  <span class="lazy-preloader"></span>
                {%- endif -%}
                <noscript><span class="ll-fallback" style="background-image:url({{ block.settings.image | img_url: '960x' }})"></span></noscript> 
              {% else %}
                <span class="onboarding-svg">{{ 'image' | replace: 'X', no | placeholder_svg_tag }}</span>
              {% endunless %}

            </span> 

          </div>

          <div class="site-box box--big lap--box--bigger box__text box--typo-big box--center-align box--column-flow" data-order="1">

            <div class="site-box-content">

              {% unless block.settings.title == blank %}
                <{{ heading_element }} class="block-heading">{{ block.settings.title | escape }}</{{ heading_element }}>
              {% endunless %}
              <div class="rte">
                {{ block.settings.content }}
              </div>

              {% unless block.settings.btn_label == blank %}
                <a class="button with-icon" {% unless block.settings.btn_url == blank %} href="{{ block.settings.btn_url | escape }}" {% endunless %} title="{{ block.settings.btn_label | escape }}"><span>{{ block.settings.btn_label | escape }}</span> <span class="icon" aria-hidden="true">{% render 'theme-symbols', icon: 'arrow_icon_smallest' %}</span></a>
              {% endunless %}

            </div>

          </div>

        {%- when 'video' -%}

          <div class="site-box box--typo-bigger box--center-align box--column-flow box__video-background box__image-text button-true align--{{ block.settings.txt_align }}">

            <div class="site-box-content">

              <div class="content">

                {% unless block.settings.caption == blank %}
                  <p class="caption">{{ block.settings.caption | escape }}</p>
                {% endunless %}

                {%- unless block.settings.heading == blank -%}
                  <{{ heading_element }} class="title">{{ block.settings.heading | escape }}</{{ heading_element }}>
                {% endunless %}

                {%- unless block.settings.button == blank -%}
                  <a class="button with-icon" {% unless block.settings.link == blank %} href="{{ block.settings.link }}" {% endunless %}> {{ block.settings.button | escape }} <span class="icon" aria-hidden="true">{% render 'theme-symbols', icon: 'arrow_icon_smallest' %}</span></a>
                {% endunless %}

              </div>

            </div>

            {%- unless block.settings.video == blank -%}
              <div class="site-box-video-background" data-src="{{ block.settings.video }}"></div>
            {%- endunless -%}

            {%- unless block.settings.image == blank -%}

              <span class="site-box-background with-image" aria-hidden="true">
                
                <img
                  src="{{ block.settings.image | img_url: '960x' }}" alt="{{ block.settings.image.alt | escape }}"
                  srcset="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="
                  data-srcset="{{ block.settings.image | img_url: '600x' }} 480w, {{ block.settings.image | img_url: '860x' }} 720w, {{ block.settings.image | img_url: '1100x' }} 960w, {{ block.settings.image | img_url: '1600x' }} 1440w, {{ block.settings.image | img_url: '2100x' }} 1920w"
                  data-sizes="auto"
                  class="lazyload" />

                <noscript><span class="ll-fallback" style="background-image:url({{ block.settings.image | img_url: '960x' }})"></span></noscript> 

              </span> 

            {%- endunless -%}

          </div>

          {%- when 'image' -%}

            <div class="site-box site-box box--center-align box--column-flow box--typo-big box__image-text align--{{ block.settings.txt_align }}" style="min-height: {{ block.settings.image_height }}">

              <div class="site-box-content">
                <div class="content">
                  {% unless block.settings.title == blank %}
                    <{{ heading_element }} class="title">{{ block.settings.title | escape }}</{{ heading_element }}>
                  {% endunless %}
                </div>
              </div>

              <span class="site-box-background {% if block.settings.title != blank %} with-image {% endif %}" aria-hidden="true">

                {% unless block.settings.image == blank %}  
                  <img
                    src="{{ block.settings.image | img_url: '960x' }}" alt="{{ block.settings.image.alt | escape }}"
                    srcset="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="
                    data-srcset="{{ block.settings.image | img_url: '600x' }} 480w, {{ block.settings.image | img_url: '860x' }} 720w, {{ block.settings.image | img_url: '1100x' }} 960w, {{ block.settings.image | img_url: '1440x' }} 1600w, {{ block.settings.image | img_url: '2100x' }} 1920w"
                    data-sizes="auto"
                    class="lazyload" 
                  />
                  {%- if settings.show_preloader and block.settings.title == blank -%}
                    <span class="lazy-preloader"></span>
                  {%- endif -%}
                  <noscript><span class="ll-fallback" style="background-image:url({{ block.settings.image | img_url: '960x' }})"></span></noscript> 
                {% else %}
                  <span class="onboarding-svg">{{ 'image' | replace: 'X', no | placeholder_svg_tag }}</span>
                {% endunless %}

              </span> 

            </div>

      {%- endcase -%}

    </div>

    {%- if block.settings.color_text and block.settings.color_text != 'rgba(0,0,0,0)' -%}

      {%- assign color_text = block.settings.color_text -%}
      {%- assign color_text_brightness = color_text | color_brightness -%}
      {%- if color_text_brightness > 150 -%}
        {%- assign color_text_foreground = '#000' -%}
      {%- else -%}
        {%- assign color_text_foreground = '#fff' -%}
      {%- endif -%}

      {%- assign color_accent = settings.color_accent -%}
      {%- assign color_accent_brightness = color_accent | color_brightness -%}
      {%- if color_accent_brightness > 150 -%}
        {%- assign color_accent_foreground = '#000' -%}
      {%- else -%}
        {%- assign color_accent_foreground = '#fff' -%}
      {%- endif -%} 

      {%- style -%}
        #shopify-section-{{ block.id }} .box__image-text,
        #shopify-section-{{ block.id }} .box__image-text a.site-box-content {
          color: {{ block.settings.color_text }};
        }
        #shopify-section-{{ block.id }} .box__image-text .title.add-hr:after {
          background: {{ block.settings.color_text }};
        }
        #shopify-section-{{ block.id }} .box__image-text a.button {
          background: {{ block.settings.color_text }};
          color: {{ color_text_foreground }} !important;
        }
        #shopify-section-{{ block.id }} .box__image-text a.button:hover {
          color: {{ color_accent_foreground }} !important;
        }
      {%- endstyle -%}

    {%- endif -%}

    {%- if block.settings.color_bg and block.settings.color_bg != 'rgba(0,0,0,0)' -%}
      {%- style -%}
        #shopify-section-{{ block.id }} .site-box-background.with-image:after {
          background: {{ block.settings.color_bg }};
        }
      {%- endstyle -%}
    {%- endif -%}

  </div>

{%- endfor -%}

{% schema %}
  {
    "name": "Story page content",
    "class": "index-section mount-content-row mount-video-background",
    "blocks": [
      {
        "type": "text",
        "name": "Text with image",
        "settings": [
          {
            "type": "text",
            "id": "title",
            "label": "Heading",
            "default": "Heading"
          },
          {
            "type": "richtext",
            "id": "content",
            "label": "Text",
            "default": "<p><strong>Insert your own content here!</strong></p><p>Use this area to write about your products, add some store information, or any useful piece of information that you wish to write about.</p>"
          },
          {
            "type": "text",
            "id": "btn_label",
            "label": "Button",
            "default": "More info"
          },
          {
            "type": "url",
            "id": "btn_url",
            "label": "Link"
          },
          {
            "type": "image_picker",
            "id": "image",
            "label": "Background image"
          }
        ]
      },
      {
        "type": "video",
        "name": "Video with text overlay",
        "settings": [
          {
            "type": "text",
            "id": "heading",
            "label": "Heading",
            "default": "Video with text"
          },
          {
            "type": "text",
            "id": "caption",
            "label": "Caption",
            "default": "Share your brand's story"
          },
          {
            "type": "text",
            "id": "button",
            "label": "Button label"
          },
          {
            "type": "url",
            "id": "link",
            "label": "Button link"
          },
          {
            "id": "video",
            "type": "text",
            "label": "Video URL",
            "info": "Path to an .mp4 video file",
            "default": "//cdn.shopify.com/s/files/1/0266/9543/4315/files/Share_your_brand_story_by_adding_a_video_to_your_store.mp4?3663"
          },
          {
            "type": "image_picker",
            "id": "image",
            "label": "Fallback image",
            "info": "A fallback image will be used on mobile devices where autoplay might be disabled."
          },
          {
            "type": "select",
            "id": "txt_align",
            "label": "Text alignment",
            "options": [
              {
                "value": "left",
                "label": "Left"
              },
              {
                "value": "center",
                "label": "Center"
              },
              {
                "value": "right",
                "label": "Right"
              }
            ],
            "default": "center"
          },
          {
            "type": "color",
            "id": "color_text",
            "label": "Text color",
            "default": "rgba(0,0,0,0)"
          }
        ]
      },
      {
        "type": "image",
        "name": "Image",
        "settings": [
          {
            "type": "image_picker",
            "id": "image",
            "label": "Image"
          }, 
          {
            "type": "select",
            "id": "image_height",
            "label": "Image height",
            "options": [
              {
                "value": "50vh",
                "label": "Medium"
              },
              {
                "value": "75vh",
                "label": "Large"
              },
              {
                "value": "100vh",
                "label": "Full"
              }
            ],
            "default": "50vh"
          },
          {
            "type": "text",
            "id": "title",
            "label": "Heading"
          },
          {
            "type": "select",
            "id": "txt_align",
            "label": "Text alignment",
            "options": [
              {
                "value": "left",
                "label": "Left"
              },
              {
                "value": "center",
                "label": "Center"
              },
              {
                "value": "right",
                "label": "Right"
              }
            ],
            "default": "center"
          },
          {
            "type": "header",
            "content": "Colors"
          },
          {
            "type": "color",
            "id": "color_text",
            "label": "Custom text color",
            "default": "rgba(0,0,0,0)"
          },
          {
            "type": "color",
            "id": "color_bg",
            "label": "Background overlay",
            "default": "rgba(0,0,0,0)"
          }
        ]
      }
    ]
  }
{% endschema %}